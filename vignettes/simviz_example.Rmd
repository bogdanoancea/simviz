---
title: "Example of use of simviz package"
author: ""
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r, echo=FALSE}
library(simviz)
library(ggplot2)
library(viridis)
library(stars)
library(gganimate)
```



# Visualization of simulator outputs

In this document it is shown how to do the visualization of the object from the simulator of MNO data with the tools in simviz package. Some simple examples are executed in the following.

First of all the reading of the data that can be done with the function \code{create_simElements} which returns a list with the following elements:

 - \code{map}: a WKT object with the map.
 - \code{network}: an object of class \linkS4class{sf} with the information about the network.
 - \code{coverage}: an object of class \linkS4class{sf} with the information about the coverage.
 - \code{grid}: an object of class \linkS4class{stars} with the information about the grid.
 - \code{individuals}: an object of class \linkS4class{data.table} with the information about the individuals.


```{r}
filename_map      <- system.file("extdata/input_files", "map.wkt", 
                                 package = "simviz")
filename_network  <- c(csv = system.file("extdata/output_files", "antennas.csv", 
                                         package = "simviz"),
                        xml = system.file("extdata/metadata/output_files", "antennas_dict.xml", 
                                          package = "simviz"))
                        
filename_coverage <- c(csv = system.file("extdata/output_files", "AntennaCells_MNO1.csv", 
                                         package = "simviz"),
                        xml = system.file("extdata/metadata/output_files", "AntennaCells_dict.xml", 
                                          package = "simviz"))
                        
filename_grid     <- c(csv = system.file("extdata/output_files", "grid.csv", package = "simviz"),
                       xml = system.file("extdata/metadata/output_files", "grid_dict.xml", 
                                         package = "simviz"))
 
filename_individ  <- c(csv = system.file("extdata/output_files", "persons.csv", package = "simviz"),
                        xml = system.file("extdata/metadata/output_files", "persons_dict.xml", 
                                          package = "simviz"))   
                        
filenames <- list(
   map                = filename_map,
   network_parameters = filename_network,
   coverage_cells     = filename_coverage,
   grid               = filename_grid,
   individuals        = filename_individ)
   

simElem.list <- create_simElements(filenames, crs = 2062)
```


## Static example


### Visualize the territory and the network

```{r}
territory.list <- list(map = simElem.list$map,
                  grid = simElem.list$grid)

simplot(territory.list, control.map = list(size = 1.5),
       control.grid = list(fill = NA))

```

### Visualize the network information 

```{r}
territory_network.list <- simElem.list
territory_network.list$individuals <- NULL

simplot(territory_network.list, control.map = list(size = 1.5),
       control.grid = list(fill = NA),
       control.coverage = list(alpha = 0.1, fill = "power"),
       control.network = list(label = "Antenna ID", nudge_x = 1, nudge_y = 1))

```

### Visualize all the information about the ground truth

```{r}
simplot(simElem.list, control.map = list(size = 1.5),
       control.grid = list(fill = NA),
       control.coverage = list(alpha = 0.1, fill = "power"),
       control.network = list(label = "Antenna ID", nudge_x = 1, nudge_y = 1),
       control.individuals = list(t = 0, animate = FALSE))
```

The previous code is equivalent to do the following:
```{r eval=FALSE, include=TRUE}
ggplot() +
  geom_sf(data = simElem.list$map, size = 1.5) +
  geom_stars(data = simElem.list$grid, fill = NA) +
  geom_sf(data = simElem.list$coverage, aes(fill = simElem.list$network$power), alpha = 0.1) +
  geom_sf(data = simElem.list$network) +
  geom_sf_label(data = simElem.list$network, mapping = aes(label = `Antenna ID`), nudge_x = 1, nudge_y = 1) +
  geom_point(data = simElem.list$individuals[t==0], mapping = aes(x, y, color = factor(nDev))) +
  labs(fill = "power (dBm)") + 
  labs(color = "Num. Devices", x = 'longitude', y = 'latitude') +
  scale_fill_viridis() +
  theme_bw()
```


## Dinamic example

### Generate an animation along time

```{r}

anim1 <- simplot(simElem.list, control.map = list(size = 1.5),
       control.grid = list(fill = NA),
       control.coverage = list(alpha = 0.1, fill = "power"),
       control.network = list(label = "Antenna ID", nudge_x = 1, nudge_y = 1),
       control.individuals = list(animate = TRUE))

times <- unique(simElem.list$individuals[, t])

# gganimate::animate(
#   anim1 ,
#   fps = 4,
#   nframes = 2 * length(times),
#   renderer = gifski_renderer(file.path("C:", paste0("animate_example.gif")))
# )
```


# Visualization of model outputs
(In progress)